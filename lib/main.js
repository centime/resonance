// Generated by CoffeeScript 1.4.0
(function() {
  var URL, channelsToWorkers, client, currentNick, data, irc, passEvent, sha1, storage, tabToPreviousPage, tabs, widgets, _ref;

  widgets = require("sdk/widget");

  URL = require('sdk/url').URL;

  tabs = require('sdk/tabs');

  data = require("sdk/self").data;

  storage = require("sdk/simple-storage").storage;

  sha1 = require('./sha1.js').sha1;

  irc = require('./bundle');

  currentNick = (_ref = storage.nick) != null ? _ref : 'Resonance-dev';

  client = new irc.Client('chat.freenode.net', currentNick, {
    debug: false
  });

  client.addListener('message', function(from, to, message) {
    if (to !== currentNick) {
      return channelsToWorkers[to].port.emit('message', from, to, message);
    }
  });

  client.addListener('pm', function(from, message) {
    var chan, worker, _i, _j, _len, _len1, _results, _results1;
    if (from === 'Resonance-bot') {
      _results = [];
      for (worker = _i = 0, _len = channelsToWorkers.length; _i < _len; worker = ++_i) {
        chan = channelsToWorkers[worker];
        _results.push(worker.port.emit('topPages', message));
      }
      return _results;
    } else {
      _results1 = [];
      for (worker = _j = 0, _len1 = channelsToWorkers.length; _j < _len1; worker = ++_j) {
        chan = channelsToWorkers[worker];
        _results1.push(worker.port.emit('message', message));
      }
      return _results1;
    }
  });

  client.addListener('part', function(chan, nick) {
    if (nick !== currentNick) {
      return channelsToWorkers[chan].port.emit('part', chan, nick);
    }
  });

  passEvent = function(eventName) {
    return client.addListener(eventName, function(chan, a, b, c, d, e, f, g, h, i) {
      if (channelsToWorkers[chan] != null) {
        return channelsToWorkers[chan].port.emit(eventName, chan, a, b, c, d, e, f, g, h, i);
      }
    });
  };

  passEvent('names');

  passEvent('join');

  tabToPreviousPage = [];

  channelsToWorkers = {};

  tabs.on('ready', function(tab) {
    var chan, currentTab, i, worker;
    currentTab = -1;
    i = 0;
    while (i < tabs.length) {
      if (tab === tabs[i]) {
        currentTab = i;
      }
      i++;
    }
    if (tabToPreviousPage[currentTab] != null) {
      client.part(tabToPreviousPage[currentTab].chan);
      delete channelsToWorkers[tabToPreviousPage[currentTab].chan];
      client.say('Resonance-bot', '/leave ' + tabToPreviousPage[currentTab].url);
    }
    chan = '#' + sha1(tab.url.host + tab.title).toString();
    client.join(chan);
    client.say('Resonance-bot', '/enter ' + tab.url);
    tabToPreviousPage[currentTab] = {
      'url': tab.url,
      'chan': chan
    };
    worker = tab.attach({
      contentScriptFile: [data.url("lib/jquery.js"), data.url("lib/angular.min.js"), data.url("content-built.js"), data.url("controllers/app.js"), data.url("controllers/ResonanceController.js"), data.url("controllers/IrcController.js"), data.url("controllers/MessagesController.js"), data.url("controllers/UsersController.js"), data.url("controllers/TopPagesController.js"), data.url("controllers/SettingsController.js")]
    });
    channelsToWorkers[chan] = worker;
    worker.port.emit('chan', chan);
    worker.port.emit('nick', currentNick);
    worker.port.on('say', function(to, text) {
      client.say(to, text);
      return worker.port.emit('message', currentNick, to, text);
    });
    worker.port.on('getTopPages', function() {
      return client.say('Resonance-bot', '/ask');
    });
    return worker.port.on("newNick", function(nick) {
      storage.nick = nick;
      currentNick = nick;
      return worker.port.emit('message', 'Resonance', currentNick, 'Your new nick will be saved and available as soon as you restart firefox.');
    });
  });

}).call(this);
